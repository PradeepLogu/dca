/*!
 * jQuery doTimeout: Like setTimeout, but better! - v1.0 - 3/3/2010
 * http://benalman.com/projects/jquery-dotimeout-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
// Copyright (c) 2010 "Cowboy" Ben Alman,
!function(e){"$:nomunge";function t(t){function a(){t?s.removeData(t):h&&delete i[h]}function r(){l.id=setTimeout(function(){l.fn()},p)}var s,o=this,l={},c=t?e.fn:e,u=arguments,d=4,h=u[1],p=u[2],m=u[3];if("string"!=typeof h&&(d--,h=t=0,p=u[1],m=u[2]),t?(s=o.eq(0),s.data(t,l=s.data(t)||{})):h&&(l=i[h]||(i[h]={})),l.id&&clearTimeout(l.id),delete l.id,m)l.fn=function(e){"string"==typeof m&&(m=c[m]),m.apply(o,n.call(u,d))!==!0||e?a():r()},r();else{if(l.fn)return void 0===p?a():l.fn(p===!1),!0;a()}}var i={},a="doTimeout",n=Array.prototype.slice;e[a]=function(){return t.apply(window,[0].concat(n.call(arguments)))},e.fn[a]=function(){var e=n.call(arguments),i=t.apply(this,[a+e[0]].concat(e));return"number"==typeof e[0]||"number"==typeof e[1]?this:i}}(jQuery),function(){this.module("Dchq",function(){return this.module("PurchaseOrder",function(){var e,t,i,a,n,r,s,o,l,c,u,d,h,p,m,f,g,v,_,b,y,k,w,C;return w=this,this.init=function(){return a(),p()},this.init_once=function(){return g(),i(),u(),f(),d(),m(),h(),r(),c(),o(),n(),l(),s()},t=function(){var e;return e=$("form.purchase_orders"),0===e.length&&(e=$("form.purchase_orders_amend")),e},y=function(e,i,a){var n,r;return null==i&&(i="json"),null==a&&(a=""),n=t(),r="/purchase_orders/"+n.dom_id()+"/"+e+"."+i,a&&(r+="?"+a),r},_=function(){return y("products_list")},e=function(){return y("add_note","js")},C=function(){var e;return e=t(),e.submit()},v=function(){return void 0!==w.supplier&&null!==w.supplier},b=function(e,t){return $.ajax({url:_(),dataType:"json",data:{term:e.term,supplier_id:w.supplier.id},success:function(e){return t(e)}})},a=function(){return void 0!==gon.supplier_id&&(w.supplier={id:gon.supplier_id}),$("#search_supplier").length?($("#search_supplier").autocomplete({minLength:2,select:function(e,t){return $.post(y("assign_supplier","js"),{supplier_id:t.item.id}).done(function(){return w.supplier=t.item}).fail(function(){return Dchq.FlashMessages.error(I18n.t("purchase_orders.form.errors.error_assigning_supplier"))}),$("#assign-supplier-modal").modal("hide")},source:y("suppliers_list")}),$("#assign-supplier-modal .btn.btn-primary").click(function(){return $("#assign-supplier-modal").modal("hide")})):void 0},f=function(){return $(document).delegate("#remove-supplier-link","ajax:complete",function(e,t,i){switch(i){case"error":return Dchq.FlashMessages.error(I18n.t("purchase_orders.form.errors.error_removing_supplier"));default:return $("#supplier-info").html(""),$("#assign-supplier-link").show(),$("#purchase_order_email").val(""),$("#search_supplier").val(""),w.supplier=null}})},g=function(){return $("#search_product").length?($("#search_product").autocomplete({minLength:2,select:function(e,t){return w.productToAdd=t.item,$("#quantity").val(1)},source:b,search:function(e){return v()?void 0:(e.preventDefault(),$("#search_product").val(""),alert(I18n.t("purchase_orders.form.errors.assign_supplier_first")))}}),$("#search_product").focus()):void 0},i=function(){return $("#add-product-link").click(function(e){var t,i;return e.preventDefault(),t=$("#new_purchase_order_item"),i=w.productToAdd,v()||alert(I18n.t("purchase_orders.form.errors.assign_supplier_first")),$("#purchase_order_item_quantity")[0].validity.valid?i?$.post(y("add_product","js"),{product_id:i.id,quantity:$("#purchase_order_item_quantity").val()}).done(function(){return w.productToAdd=null}).fail(function(e){return Dchq.FlashMessages.processErrors(JSON.parse(e.responseText))}):alert(I18n.t("purchase_orders.form.errors.select_product_first")):Dchq.Validation.highlightFirstError(t)})},p=function(){return $(".shop-client-products table tbody").first().find(".selectpicker").selectpicker("render")},d=function(){return $(document).delegate('form.purchase_orders input[id*="quantity"]',"keyup paste",function(){return $(this).doTimeout("supply-price",1e3,function(e){return function(){return $(e).siblings('input[type="hidden"][id$="_destroy"]').val(0===parseInt($(e).val())),C()}}(this))})},m=function(){return $(document).delegate(".supply-price","keyup paste",function(){return $(this).doTimeout("supply-price",1e3,function(){return function(){return C()}}(this))})},h=function(){return $(document).delegate('form.purchase_orders_amend input[id$="quantity"]',"keyup paste",function(){return $(this).doTimeout("quantity",1e3,function(e){return function(){var t,i;return i=$(e).closest("tr").find('span[id$="quantity_max"]').text(),t=$(e).val(),isNaN(parseInt(t))?void 0:(0>i-t&&($(e).val(i),t=i),$("#"+e.id+"_rejected").val(i-t),C())}}(this))}),$(document).delegate('form.purchase_orders_amend input[id$="quantity_rejected"]',"keyup paste",function(){return $(this).doTimeout("quantity-rejected",1e3,function(e){return function(){var t,i;return i=$(e).closest("tr").find('span[id$="quantity_max"]').text(),t=$(e).val(),isNaN(parseInt(t))?void 0:(0>i-t&&($(e).val(i),t=i),$("#"+e.id.substr(0,e.id.length-"_rejected".length)).val(i-t),C())}}(this))})},r=function(){return $("#add-note-modal .btn.btn-primary").click(function(t){var i;return t.preventDefault(),$("#add-note-modal").modal("hide"),i=$("#add-note-modal textarea").val(),$.post(e(),{note:i}).fail(function(){return Dchq.FlashMessages.error(I18n.t("purchase_orders.form.errors.error_adding_note"))})}),$(document).delegate("#edit-note","click",function(e){return e.preventDefault(),$("#add-note-modal textarea").val($("#note-holder").text()),$("#add-note-modal").modal("show")})},u=function(){return $("#product-not-in-inventory-modal").on("show",function(){return v()?$("#product_supplier_id").select_option_by_value(w.supplier.id):void 0}),$("#product-not-in-inventory-modal .btn.btn-primary").click(function(e){var t;return e.preventDefault(),t=$("#new_product"),Dchq.Validation.formValid(t)?($("#product-not-in-inventory-modal").modal("hide"),$.post(t.attr("action"),t.serialize(),null,"json").done(function(){return Dchq.FlashMessages.success(I18n.t("purchase_orders.form.product_creation_success"))}).fail(function(){return Dchq.FlashMessages.error(I18n.t("purchase_orders.form.errors.error_creating_product"))})):Dchq.Validation.highlightFirstError(t)}),$("#product_sku_code").bind("keyup paste",function(){var e;return e=$(this).val(),$("#product_barcode").val(e)})},c=function(){var e;return e=function(e){return/^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i.test($(e).val())?($("#email-supplier-modal .modal-body").removeClass("control-group").removeClass("error"),e.emailValid=!0):($("#email-supplier-modal .modal-body").addClass("control-group").addClass("error"),e.emailValid=!1)},$("#email-supplier-modal").on("show",function(e){return v()||(e.preventDefault(),alert(I18n.t("purchase_orders.form.errors.assign_supplier_first"))),1===$(".shop-client-products table").get(0).rows.length?(e.preventDefault(),alert(I18n.t("purchase_orders.form.errors.add_items_to_order"))):void 0}),$("#purchase_order_email").bind("keyup paste",function(){return e(this)}),$("#email-supplier-modal .btn.btn-primary").click(function(t){return t.preventDefault(),e($("#purchase_order_email").get(0)),$("#purchase_order_email").get(0).emailValid?$("#email-supplier-modal form").submit():void 0}),$("#pdf-supplier-mark-sent-modal .btn.btn-success").click(function(e){return e.preventDefault(),$("#pdf-supplier-mark-sent-modal").modal("hide"),$.post(y("set_status"),{status:"sent_to_supplier"}).done(function(){return $.get(y("update_order_form_after_send","js")).done(function(){return window.location.href=$("#pdf-supplier-mark-sent-modal .btn.btn-success").prop("href")})}).fail(function(){return Dchq.FlashMessages.error(I18n.t("purchase_orders.form.errors.failed_to_mark_order_sent"))})}),$("#pdf-supplier-mark-sent-modal .btn.btn-primary").click(function(){return $("#pdf-supplier-mark-sent-modal").modal("hide")})},o=function(){return $(document).delegate("a.print","click",function(e){return e.preventDefault(),$("#print").printElement()})},n=function(){return $(document).delegate("#add-expected-delivery-date .btn.btn-primary","click",function(e){var t;return e.preventDefault(),$("#add-expected-delivery-date").modal("hide"),t=$(".expected-delivery-form"),$.post(y("set_expected_delivery","js"),t.serialize()).fail(function(){return Dchq.FlashMessages.error(I18n.t("purchase_orders.form.errors.error_setting_delivery_date"))})}),$(document).delegate('a[href="#add-expected-delivery-date"]',"click",function(){return $("#purchase_order_expected_delivery").val($("#expected-delivery-hidden").text())})},l=function(){return $(document).delegate("#set-status-received-in-part-link","click",function(e){return e.preventDefault(),$("#set-status-received-in-part-form").submit()}),$(document).delegate("#set-status-received-in-full-link","click",function(e){return e.preventDefault(),$("#set-status-received-in-full-form").submit()})},k=null,s=function(){return k=$("#mark-received-and-send-form"),$("#purchase_order_mark_received").change(function(){return k=$($(this).is(":checked")?"#mark-received-and-send-form":"#mark-received-form")}),$("#update-packing-list-modal .btn.btn-primary").click(function(e){return e.preventDefault(),k.submit()})}})}),$(function(){return Dchq.PurchaseOrder.init(),Dchq.PurchaseOrder.init_once()})}.call(this);