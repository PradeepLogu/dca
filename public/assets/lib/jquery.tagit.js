!function(e){e.widget("ui.tagit",{options:{tagSource:[],triggerKeys:["enter","space","comma","tab"],initialTags:[],minLength:1,select:!1,allowNewTags:!0,caseSensitive:!1,highlightOnExistColor:"#0F0",emptySearch:!0,tagsChanged:function(){}},_splitAt:/\ |,/g,_existingAtIndex:0,_pasteMetaKeyPressed:!1,_keys:{backspace:[8],enter:[13],space:[32],comma:[44,188],tab:[9]},_create:function(){var t=this;this.tagsArray=[],this.timer=null,this.element.addClass("tagit"),this.element.children("li").each(function(){var i=e(this).attr("tagValue");t.options.initialTags.push(i?{label:e(this).text(),value:i}:e(this).text())}),t._splitAt=null,e.inArray("space",t.options.triggerKeys)>0&&e.inArray("comma",t.options.triggerKeys)>0?t._splitAt=/\ |,/g:e.inArray("space",t.options.triggerKeys)>0?t._splitAt=/\ /g:e.inArray("comma",t.options.triggerKeys)>0&&(t._splitAt=/,/g),this.element.html('<li class="tagit-new"><input class="tagit-input" type="text" /></li>'),this.input=this.element.find(".tagit-input"),e(this.element).click(function(i){if(e(i.target).hasClass("tagit-close")){var n=e(i.target).parent();n.remove();var a=n.attr("tagValue");if(a)t._popTag(null,a);else{var s=n.text();t._popTag(s.substr(0,s.length-1))}}else t.input.focus(),t.options.emptySearch&&e(i.target).hasClass("tagit-input")&&""==t.input.val()&&void 0!=t.input.autocomplete&&t.input.autocomplete("search")});var i=this.options.select;this.options.appendTo=this.element,this.options.source=this.options.tagSource,this.options.select=function(e,i){return clearTimeout(t.timer),void 0===i.item.label?t._addTag(i.item.value):t._addTag(i.item.label,i.item.value),!1};var n=this.input;this.options.focus=function(e,t){return void 0!==t.item.label&&/^key/.test(e.originalEvent.originalEvent.type)?(n.val(t.item.label),n.attr("tagValue",t.item.value),!1):void 0},this.input.autocomplete(this.options),this.options.select=i,this.input.keydown(function(i){var n=t.element.children(".tagit-choice:last");return i.which==t._keys.backspace?t._backspace(n):(t._isInitKey(i.which)&&(i.preventDefault(),!t.options.allowNewTags||void 0!==t.options.maxTags&&t.tagsArray.length==t.options.maxTags?t.input.val(""):t.options.allowNewTags&&e(this).val().length>=t.options.minLength&&t._addTag(e(this).val())),void 0!==t.options.maxLength&&t.input.val().length==t.options.maxLength&&i.preventDefault(),n.hasClass("selected")&&n.removeClass("selected"),_pasteMetaKeyPressed=i.metaKey,void(t.lastKey=i.which))}),this.input.keyup(function(t){!_pasteMetaKeyPressed||91!=t.which&&86!=t.which||e(this).blur(),window.setTimeout(function(){_pasteMetaKeyPressed=t.metaKey},250)}),this.input.blur(function(){return t.currentLabel=e(this).val(),t.currentValue=e(this).attr("tagValue"),t.options.allowNewTags&&(t.timer=setTimeout(function(){t._addTag(t.currentLabel,t.currentValue),t.currentValue="",t.currentLabel=""},400)),e(this).val("").removeAttr("tagValue"),!1}),String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},this.options.select&&(this.element.after('<select class="tagit-hiddenSelect" name="'+this.element.attr("name")+'" multiple="multiple"></select>'),this.select=this.element.next(".tagit-hiddenSelect")),this._initialTags()},_popSelect:function(e,t){this.select.children('option[value="'+(void 0===t?e:t)+'"]').remove(),this.select.change()},_addSelect:function(t,i){var n=e("<option>").attr({selected:"selected",value:void 0===i?t:i}).text(t);this.select.append(n),this.select.change()},_popTag:function(t,i){if(void 0===t)t=this.tagsArray.pop(),"object"==typeof t&&(i=t.value,t=t.label);else{var n;if(void 0===i)n=e.inArray(t,this.tagsArray),n=-1==n?this.tagsArray.length-1:n;else{n=this.tagsArray.length-1;for(var a in this.tagsArray)if(this.tagsArray[a].value==i){n=a;break}}this.tagsArray.splice(n,1)}this.options.select&&this._popSelect(t,i),this.options.tagsChanged&&this.options.tagsChanged(i||t,"popped",null)},_addTag:function(t,i){this.input.val("");{if(!(this._splitAt&&t.search(this._splitAt)>0)){if(t=t.replace(/,+$/,""),t=t.trim(),""==t)return!1;if(this._exists(t,i))return this._highlightExisting(),!1;var n="";return n=e('<li class="tagit-choice"'+(void 0!==i?' tagValue="'+i+'"':"")+">"+t+'<a class="tagit-close">x</a></li>'),n.insertBefore(this.input.parent()),this.input.val(""),this.tagsArray.push(void 0===i?{label:t,value:t}:{label:t,value:i}),this.options.select&&this._addSelect(t,i),this.options.tagsChanged&&this.options.tagsChanged(t,"added",n),!0}for(var a=t.split(this._splitAt),s=0;s<a.length;s++)this._addTag(a[s],i)}},_exists:function(e,t){if(0==this.tagsArray.length)return!1;if(void 0===t){this._existingAtIndex=0;for(var i in this.tagsArray){var n="string"==typeof this.tagsArray[i]?this.tagsArray[i]:this.tagsArray[i].label;if(this._lowerIfCaseInsensitive(e)==this._lowerIfCaseInsensitive(n))return!0;this._existingAtIndex++}}else{this._existingAtIndex=0;for(var i in this.tagsArray){if(this._lowerIfCaseInsensitive(t)===this._lowerIfCaseInsensitive(this.tagsArray[i].value))return!0;this._existingAtIndex++}}return this._existingAtIndex=-1,!1},_highlightExisting:function(){if(void 0!==this.options.highlightOnExistColor){var t=e(e(this.element).children(".tagit-choice")[this._existingAtIndex]);t.stop();var i=t.css("color");t.animate({color:this.options.highlightOnExistColor},100).animate({color:i},800)}},_isInitKey:function(t){var i="";for(var n in this._keys)-1!=e.inArray(t,this._keys[n])&&(i=n);return-1!=e.inArray(i,this.options.triggerKeys)?!0:!1},_removeTag:function(){this._popTag(),this.element.children(".tagit-choice:last").remove()},_backspace:function(e){return""==this.input.val()&&(this.lastKey==this._keys.backspace?(this._popTag(),e.remove(),this.lastKey=null):(e.addClass("selected"),this.lastKey=this._keys.backspace)),!0},_initialTags:function(){var t,i=this;this.options.tagsChanged&&(t=this.options.tagsChanged),this.options.tagsChanged=null,0!=this.options.initialTags.length&&e(this.options.initialTags).each(function(e,t){"object"==typeof t?i._addTag(t.label,t.value):i._addTag(t)}),this.options.tagsChanged=t},_lowerIfCaseInsensitive:function(e){return void 0===e||"string"!=typeof e?e:this.options.caseSensitive?e:e.toLowerCase()},tags:function(){return this.tagsArray},destroy:function(){e.Widget.prototype.destroy.apply(this,arguments),this.tagsArray=[]},reset:function(){this.element.find(".tagit-choice").remove(),this.tagsArray=[],this.options.select&&(this.select.children().remove(),this.select.change()),this._initialTags(),this.options.tagsChanged&&this.options.tagsChanged(null,"reseted",null)},fill:function(e){this.element.find(".tagit-choice").remove(),this.tagsArray=[],void 0!==e&&(this.options.initialTags=e),this.options.select&&(this.select.children().remove(),this.select.change()),this._initialTags()},add:function(t,i){t=t.replace(/,+$/,"");{if(!(this._splitAt&&t.search(this._splitAt)>0)){if(t=t.trim(),""==t||this._exists(t,i))return!1;var n="";return n=e('<li class="tagit-choice"'+(void 0!==i?' tagValue="'+i+'"':"")+">"+t+'<a class="tagit-close">x</a></li>'),n.insertBefore(this.input.parent()),this.tagsArray.push(void 0===i?t:{label:t,value:i}),this.options.select&&this._addSelect(t,i),this.options.tagsChanged&&this.options.tagsChanged(t,"added",n),!0}for(var a=t.split(this._splitAt),s=0;s<a.length;s++)this.add(a[s],i)}}})}(jQuery);