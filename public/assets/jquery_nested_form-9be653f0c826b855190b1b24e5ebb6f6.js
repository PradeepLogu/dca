!function(e){window.NestedFormEvents=function(){this.addFields=e.proxy(this.addFields,this),this.removeFields=e.proxy(this.removeFields,this)},NestedFormEvents.prototype={addFields:function(t){var i=t.currentTarget,n=e(i).data("association"),a=e("#"+e(i).data("blueprint-id")),s=a.data("blueprint"),r=(e(i).closest(".fields").closestChild("input, textarea, select").eq(0).attr("name")||"").replace(/\[[a-z_]+\]$/,""),o=s.match(new RegExp("\\[([a-z_]+)\\]\\[new_"+n+"\\]"));if(o&&(r=r.replace(new RegExp("\\["+o[1]+"\\]\\[(new_)?\\d+\\]$"),"")),r)for(var l=r.match(/[a-z_]+_attributes(?=\]\[(new_)?\d+\])/g)||[],c=r.match(/[0-9]+/g)||[],u=0;u<l.length;u++)c[u]&&(s=s.replace(new RegExp("(_"+l[u]+")_.+?_","g"),"$1_"+c[u]+"_"),s=s.replace(new RegExp("(\\["+l[u]+"\\])\\[.+?\\]","g"),"$1["+c[u]+"]"));var d=new RegExp("new_"+n,"g"),h=this.newId();s=e.trim(s.replace(d,h));var p=this.insertFields(s,n,i);return p.trigger({type:"nested:fieldAdded",field:p}).trigger({type:"nested:fieldAdded:"+n,field:p}),!1},newId:function(){return(new Date).getTime()},insertFields:function(t,i,n){var a=e(n).data("target");return a?e(t).appendTo(e(a)):e(t).insertBefore(n)},removeFields:function(t){var i=e(t.currentTarget),n=i.data("association"),a=i.prev("input[type=hidden]");a.val("1");var s=i.closest(".fields");return s.hide(),s.trigger({type:"nested:fieldRemoved",field:s}).trigger({type:"nested:fieldRemoved:"+n,field:s}),!1}},window.nestedFormEvents=new NestedFormEvents,e(document).delegate("form a.add_nested_fields","click",nestedFormEvents.addFields).delegate("form a.remove_nested_fields","click",nestedFormEvents.removeFields)}(jQuery),/*
 * Copyright 2011, Tobias Lindig
 *
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 *
 */
function(e){e.fn.closestChild=function(t){if(t&&""!=t){var i=[];for(i.push(this);i.length>0;)for(var n=i.shift(),a=n.children(),s=0;s<a.length;++s){var r=e(a[s]);if(r.is(t))return r;i.push(r)}}return e()}}(jQuery);